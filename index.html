<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Micro:Bit Controller — Large UI</title>
<style>
  :root{
    --bg:#E84E0E;
    --white:#fff;
    --glass:rgba(255,255,255,0.06);
    --accent:rgba(255,255,255,0.12);
    --shadow:0 18px 60px rgba(0,0,0,0.25);
    --radius:22px;
    --gap:48px;
    --control-size:420px;
    --arrow-size:110px;
    --center-size:160px;
    --ctrl-gap:54px;
    --btn-h:56px;
    --font-sans:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  }

  html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:36px;box-sizing:border-box;}

  .app{
    width:1400px;max-width:96vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));
    border-radius:var(--radius);box-shadow:var(--shadow);padding:44px;display:flex;gap:var(--gap);align-items:stretch;overflow:hidden;
  }

  .panel-left{flex:1;min-width:520px;display:flex;align-items:center;justify-content:center;padding:28px;}
  .controller{
    width:var(--control-size);height:var(--control-size);
    display:grid;
    grid-template-rows: 1fr auto 1fr;
    grid-template-columns: 1fr auto 1fr;
    place-items:center;
    position:relative;
    gap:var(--ctrl-gap);
    padding-bottom: 70px;
  }

  .arrow-btn{
    width:var(--arrow-size);
    height:var(--arrow-size);
    border-radius:18px;
    background:var(--glass);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition: transform .14s cubic-bezier(.2,.9,.3,1), box-shadow .14s, background .14s;
    user-select:none;
    box-shadow: 0 18px 40px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    --icon-scale: 36px;
  }
  .arrow-btn .arrow-icon{ width:var(--icon-scale); height:var(--icon-scale); fill:#000; opacity:0.98; }
  .arrow-btn:active, .arrow-btn.pressed, .arrow-btn.active {
    transform: translateY(-8px) scale(1.03);
    box-shadow: 0 28px 60px rgba(0,0,0,0.32);
    background: linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.02));
  }

  .up{grid-row:1;grid-column:2}
  .left{grid-row:2;grid-column:1}
  .right{grid-row:2;grid-column:3}
  .down{grid-row:3;grid-column:2}

  .dot{
    grid-row:2;grid-column:2;
    width:var(--center-size);height:var(--center-size);
    border-radius:999px;background:var(--white);
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 20px 80px rgba(0,0,0,0.3);
    transform-origin:center;cursor:pointer;
  }
  .dot svg{width:56px;height:56px;fill:var(--bg)}
  .dot.listening{ box-shadow: 0 32px 110px rgba(0,0,0,0.42), 0 0 0 12px rgba(255,255,255,0.06); }
  .dot.listening::after{
    content:"";
    position:absolute;inset:-8px;border-radius:999px;border:2px solid rgba(255,255,255,0.22);
    animation:ping 1.2s cubic-bezier(.2,.9,.3,1) infinite;
  }
  @keyframes ping{0%{transform:scale(1);opacity:.7}100%{transform:scale(1.28);opacity:0}}

  .ripple{position:absolute;width:18px;height:18px;border-radius:999px;background:rgba(255,255,255,0.12);pointer-events:none;transform:scale(0);opacity:0;}

  .control-modes{
    display:flex;
    gap:12px;
    margin-bottom:20px;
    justify-content:center;
  }
  .mode-btn{
    background:var(--glass);
    color:var(--white);
    border:1px solid rgba(255,255,255,0.06);
    padding:12px 24px;
    border-radius:12px;
    cursor:pointer;
    font-weight:800;
    font-size:14px;
    transition:all .2s ease;
    user-select:none;
  }
  .mode-btn.active{
    background:var(--white);
    color:var(--bg);
    box-shadow:0 8px 24px rgba(0,0,0,0.15);
  }
  .mode-btn:hover:not(.active){
    background:rgba(255,255,255,0.08);
  }

  .panel-right{
    width:520px; max-width:48%;
    padding:28px;
    display:flex;
    flex-direction:column;
    gap:20px;
    align-items:stretch;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:22px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 14px 40px rgba(0,0,0,0.12);
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .slider-row{display:flex;align-items:center;gap:18px;}
  .slider-label{width:110px;font-weight:800;font-size:14px;opacity:.98}
  input[type=range]{-webkit-appearance:none;appearance:none;height:8px;flex:1;background:transparent;outline:none;border-radius:8px;}
  input[type=range]::-webkit-slider-runnable-track{height:8px;background:linear-gradient(90deg,rgba(255,255,255,0.14),rgba(255,255,255,0.06));border-radius:8px;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--white);box-shadow:0 12px 36px rgba(0,0,0,0.28);margin-top:-7px;}
  .value-badge{min-width:56px;text-align:center;font-weight:800;background:var(--accent);padding:10px;border-radius:12px;font-size:15px;}

  .voice-display{
    padding:16px;border-radius:12px;background: rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.02);min-height:64px;
    display:flex;flex-direction:column;gap:8px;font-weight:700;
  }
  .voice-label{opacity:0.85;font-size:13px;font-weight:800}

  .device-controls{
    display:flex;gap:14px;align-items:center;justify-content:flex-start;
  }
  .btn{background:var(--white);color:var(--bg);border:none;padding:12px 20px;border-radius:14px;cursor:pointer;font-weight:800;height:var(--btn-h);box-shadow:0 16px 40px rgba(0,0,0,0.12);font-size:15px;}
  .btn.ghost{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.06);}
  .conn-small{font-size:16px;opacity:.9;color:rgba(255,255,255,0.95);text-align:center;margin-bottom:16px;font-weight:600;}

  .arrow-btn.active { background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.03)); }

  .voice-mode .arrow-btn{ display:none; }
  .button-mode .dot{ display:none; }
  .voice-mode .controller{ grid-template-rows: 1fr; grid-template-columns: 1fr; place-items:center; }

  @media (max-width:1200px){
    :root{ --control-size:360px; --arrow-size:90px; --center-size:140px; --gap:28px; }
    .panel-right{width:440px;}
  }
  @media (max-width:900px){
    .app{flex-direction:column;padding:18px;}
    .panel-left{min-width:unset;}
    .panel-right{width:100%;}
    :root{ --control-size:320px; --arrow-size:82px; --center-size:120px; --gap:20px;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="app" role="application" aria-label="Microbit Controller">
    <div class="panel-left">
      <div class="controller" id="controller">
        <div class="arrow-btn up" data-dir="forward" id="btn-up" title="Forward" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M12 4l-8 8h6v8h4v-8h6z"/></svg>
        </div>

        <div class="arrow-btn left" data-dir="left" id="btn-left" title="Left" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M6 12l8-8v6h8v4h-8v6z"/></svg>
        </div>

        <div class="dot" id="voiceBtn" title="Press to speak" role="button" tabindex="0" aria-pressed="false" aria-label="Voice input">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2z"/></svg>
        </div>

        <div class="arrow-btn right" data-dir="right" id="btn-right" title="Right" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M18 12l-8 8v-6H2v-4h8V4z"/></svg>
        </div>

        <div class="arrow-btn down" data-dir="backward" id="btn-down" title="Backward" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M12 20l8-8h-6V4h-4v8H4z"/></svg>
        </div>

        <div class="ripple" id="ripple"></div>
      </div>
    </div>

    <div class="panel-right">
      <div class="control-modes">
        <button class="mode-btn active" id="buttonModeBtn">Button Control</button>
        <button class="mode-btn" id="voiceModeBtn">Voice Control</button>
      </div>
      
      <div class="conn-small" id="connSmall">Not connected</div>

      <div class="card">
        <div class="slider-row" aria-hidden="false">
          <div class="slider-label">SPEED</div>
          <input id="slider1" type="range" min="0" max="100" value="50" aria-label="Speed control">
          <div id="v1" class="value-badge">50</div>
        </div>

        <div class="voice-display" id="voiceDisplay">
          <div>
            <div class="voice-label">Recognized</div>
            <div id="voiceText" style="margin-top:6px;font-size:16px;opacity:.98">—</div>
          </div>
        </div>

        <div class="device-controls">
          <button id="connectBtn" class="btn">Connect</button>
          <button id="disconnectBtn" class="btn ghost">Disconnect</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_TX_CHARACTERISTIC_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX_CHARACTERISTIC_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

let uBitDevice;
let txCharacteristic;
let rxCharacteristic;

const connSmall = document.getElementById('connSmall');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const slider1 = document.getElementById('slider1');
const v1 = document.getElementById('v1');
const voiceTextEl = document.getElementById('voiceText');
const voiceBtn = document.getElementById('voiceBtn');
const ripple = document.getElementById('ripple');
const buttonModeBtn = document.getElementById('buttonModeBtn');
const voiceModeBtn = document.getElementById('voiceModeBtn');
const controller = document.getElementById('controller');

let currentMode = 'button';

function setConnText(t, color){
  connSmall.textContent = t;
  connSmall.style.color = color || 'white';
}

function switchMode(mode) {
  currentMode = mode;
  buttonModeBtn.classList.toggle('active', mode === 'button');
  voiceModeBtn.classList.toggle('active', mode === 'voice');
  controller.className = 'controller';
  if (mode === 'voice') {
    controller.classList.add('voice-mode');
  } else {
    controller.classList.add('button-mode');
  }
  document.querySelectorAll('.arrow-btn').forEach(btn => {
    btn.classList.remove('active', 'pressed');
  });
  voiceBtn.classList.remove('listening');
  voiceTextEl.textContent = '—';
}

buttonModeBtn.addEventListener('click', () => switchMode('button'));
voiceModeBtn.addEventListener('click', () => switchMode('voice'));
switchMode('button');

async function connectButtonPressed() {
  try {
    setConnText('Pairing...', 'yellow');
    uBitDevice = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "BBC micro:bit" }],
      optionalServices: [UART_SERVICE_UUID]
    });
    
    uBitDevice.addEventListener('gattserverdisconnected', onDisconnected);
    setConnText('Connecting...', 'yellow');
    const server = await uBitDevice.gatt.connect();
    setConnText('Getting service...', 'yellow');
    const service = await server.getPrimaryService(UART_SERVICE_UUID);
    setConnText('Getting characteristics...', 'yellow');
    
    rxCharacteristic = await service.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);
    txCharacteristic = await service.getCharacteristic(UART_TX_CHARACTERISTIC_UUID);
    
    await rxCharacteristic.startNotifications();
    rxCharacteristic.addEventListener("characteristicvaluechanged", onRxCharacteristicValueChanged);
    
    setConnText('Connected: ' + (uBitDevice.name || 'Micro:Bit'), '#b5f27d');
    console.log('Bluetooth connected successfully!');
  } catch (error) {
    console.error('Connect failed', error);
    setConnText('Connection failed', 'salmon');
  }
}

function disconnectButtonPressed() {
  if (!uBitDevice) return;
  if (uBitDevice.gatt.connected) {
    uBitDevice.gatt.disconnect();
  }
}

function onDisconnected(event) {
  setConnText('Disconnected', 'white');
  uBitDevice = null;
  txCharacteristic = null;
  rxCharacteristic = null;
}

connectBtn.addEventListener('click', connectButtonPressed);
disconnectBtn.addEventListener('click', disconnectButtonPressed);

async function sendUART(data) {
  if (!txCharacteristic) {
    setConnText('Not connected - Click Connect first', 'salmon');
    return;
  }
  
  let encoder = new TextEncoder();
  queueGattOperation(() => 
    txCharacteristic.writeValue(encoder.encode(data + "\n"))
      .then(() => console.log("SENT:", data))
      .catch(error => console.error('Send error:', error))
  );
}

let queue = Promise.resolve();
function queueGattOperation(operation) {
  queue = queue.then(operation, operation);
  return queue;
}

function onRxCharacteristicValueChanged(event) {
  let receivedData = [];
  for (var i = 0; i < event.target.value.byteLength; i++) {
    receivedData[i] = event.target.value.getUint8(i);
  }
  const receivedString = String.fromCharCode.apply(null, receivedData);
  console.log("RECEIVED from Micro:Bit:", receivedString);
  
  if (receivedString.includes("S")) {
    console.log("Shaken!");
  }
}

function animateRipple(){
  const size = Math.max(160, window.innerWidth * 0.08);
  ripple.style.width = ripple.style.height = size + 'px';
  ripple.style.left = `calc(50% - ${size/2}px)`;
  ripple.style.top = `calc(50% - ${size/2}px)`;
  ripple.animate(
    [{transform:'scale(0)', opacity:0.28},{transform:'scale(1.08)', opacity:0.12},{transform:'scale(1.6)', opacity:0}],
    {duration:520, easing:'cubic-bezier(.2,.9,.3,1)'}
  );
}

let sBusy=false;
slider1.addEventListener('input', (e)=>{
  v1.textContent = e.target.value;
  if(sBusy) return;
  sBusy=true;
  sendUART(`SPEED:${e.target.value}`);
  setTimeout(()=> sBusy=false, 140);
});

const arrowButtons = document.querySelectorAll('.arrow-btn');
arrowButtons.forEach(btn=>{
  const dir = btn.dataset.dir;
  const press = (ev)=>{
    ev.preventDefault();
    if(currentMode !== 'button') return;
    btn.classList.add('pressed','active');
    animateRipple();
    sendUART(dir);
  };
  const release = (ev)=>{
    ev.preventDefault();
    if(currentMode !== 'button') return;
    btn.classList.remove('pressed');
    setTimeout(()=> btn.classList.remove('active'), 180);
    sendUART('stop');
  };
  btn.addEventListener('mousedown', press);
  btn.addEventListener('touchstart', press, {passive:true});
  btn.addEventListener('mouseup', release);
  btn.addEventListener('mouseleave', release);
  btn.addEventListener('touchend', release);
  btn.addEventListener('keydown', (e)=>{ if(e.key === ' ' || e.key === 'Enter'){ press(e); }});
  btn.addEventListener('keyup', (e)=>{ if(e.key === ' ' || e.key === 'Enter'){ release(e); }});
});

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recognizer = null;

function mapVoiceToCommand(text){
  const t = text.trim().toLowerCase();
  if(t.includes('forward') || t.includes('up') || t.includes('ahead') || t.includes('go')) return 'forward';
  if(t.includes('back') || t.includes('backward') || t.includes('down') || t.includes('reverse')) return 'backward';
  if(t.includes('left')) return 'left';
  if(t.includes('right')) return 'right';
  if(t.includes('stop') || t.includes('halt')) return 'stop';
  return null;
}

function startVoice(){
  if(!SpeechRecognition){ alert('Speech recognition not supported'); return; }
  if(currentMode !== 'voice') return;
  
  if(!recognizer){
    recognizer = new SpeechRecognition();
    recognizer.lang = 'en-US';
    recognizer.continuous = false;
    recognizer.onresult = (e)=>{
      const transcript = e.results[0][0].transcript.trim();
      voiceTextEl.textContent = transcript;
      sendUART(`VOICE:${transcript}`);
      const mapped = mapVoiceToCommand(transcript);
      if(mapped) sendUART(mapped);
    };
    recognizer.onend = ()=> voiceBtn.classList.remove('listening');
  }
  
  voiceBtn.classList.add('listening');
  recognizer.start();
  setTimeout(() => recognizer.stop(), 1000);
}

voiceBtn.addEventListener('click', (e)=> { 
  e.preventDefault(); 
  if(currentMode === 'voice') startVoice(); 
});
</script>
</body>
</html>
