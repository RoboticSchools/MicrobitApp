<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Micro:Bit Controller (press & hold voice)</title>
<style>
  :root{
    --bg:#E84E0E;
    --white:#fff;
    --glass:rgba(255,255,255,0.06);
    --accent:rgba(255,255,255,0.12);
    --shadow:0 8px 24px rgba(0,0,0,0.18);
    --radius:18px;
    --gap:28px;
    --control-size:220px;
    --ctrl-gap:34px;
    --btn-h:44px;
    --font-sans:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  }

  html,body{height:100%;margin:0;font-family:var(--font-sans);background:var(--bg);color:var(--white);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:36px;box-sizing:border-box;}

  .app{
    width:1200px;max-width:96vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));
    border-radius:22px;box-shadow:var(--shadow);padding:36px;display:flex;gap:var(--gap);align-items:stretch;overflow:hidden;
  }

  .panel-left{flex:1;min-width:420px;display:flex;align-items:center;justify-content:center;padding:28px;}
  .controller{
    width:var(--control-size);height:var(--control-size);
    display:grid;grid-template-rows: 1fr auto 1fr;grid-template-columns: 1fr auto 1fr;place-items:center;position:relative;gap:var(--ctrl-gap);
  }

  .dot{
    grid-row:2;grid-column:2;width:120px;height:120px;border-radius:999px;background:var(--white);
    display:flex;align-items:center;justify-content:center;box-shadow:0 10px 40px rgba(0,0,0,0.2);transform-origin:center;cursor:pointer;
    user-select:none;
  }
  .dot svg{width:44px;height:44px;fill:var(--bg);}
  .dot.listening{box-shadow:0 0 0 10px rgba(255,255,255,0.08),0 16px 40px rgba(0,0,0,0.28);}
  .dot.listening::after{
    content:"";
    position:absolute;inset:-6px;border-radius:999px;border:2px solid rgba(255,255,255,0.35);
    animation:ping 1.1s cubic-bezier(.2,.9,.3,1) infinite;
  }
  @keyframes ping{0%{transform:scale(1);opacity:.6}100%{transform:scale(1.24);opacity:0}}

  .arrow-btn{
    width:72px;height:72px;border-radius:14px;background:var(--glass);display:flex;align-items:center;justify-content:center;
    cursor:pointer;transition:transform .14s cubic-bezier(.2,.9,.3,1),box-shadow .14s,background .14s;user-select:none;-webkit-user-select:none;
    box-shadow:0 6px 18px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);
  }
  .arrow-icon{width:26px;height:26px;display:inline-block;opacity:.95;filter:drop-shadow(0 2px 0 rgba(0,0,0,0.06));fill:#000;}
  .arrow-btn:active,.arrow-btn.pressed{transform:translateY(-6px) scale(1.04);box-shadow:0 18px 40px rgba(0,0,0,0.28);background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));}

  .up{grid-row:1;grid-column:2}
  .left{grid-row:2;grid-column:1}
  .right{grid-row:2;grid-column:3}
  .down{grid-row:3;grid-column:2}

  .ripple{position:absolute;width:18px;height:18px;border-radius:999px;background:rgba(255,255,255,0.12);pointer-events:none;transform:scale(0);opacity:0;}

  .panel-right{width:460px;max-width:44%;padding:24px;display:flex;flex-direction:column;gap:18px;justify-content:flex-start;}
  .sliders{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);}
  .slider-row{display:flex;align-items:center;gap:14px;}
  .slider-label{width:78px;font-weight:600;font-size:13px;opacity:.95}
  input[type=range]{-webkit-appearance:none;appearance:none;height:6px;flex:1;background:transparent;outline:none;}
  input[type=range]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg,rgba(255,255,255,0.12),rgba(255,255,255,0.06));border-radius:6px;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--white);box-shadow:0 6px 18px rgba(0,0,0,0.18);margin-top:-6px;}
  .value-badge{min-width:42px;text-align:center;font-weight:700;background:var(--accent);padding:8px;border-radius:10px;font-size:13px;}

  .device-controls{display:flex;gap:12px;align-items:center;}
  .btn{background:var(--white);color:var(--bg);border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;height:var(--btn-h);box-shadow:0 8px 20px rgba(0,0,0,0.12);}
  .btn.ghost{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.06);}
  .status{font-size:13px;opacity:.95;margin-left:6px;font-weight:700;}
  .hint{font-size:12px;opacity:.85}

  /* recognized voice display */
  .voice-display{
    margin-top:8px;
    padding:12px;
    border-radius:12px;
    background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.02);
    min-height:44px;
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:700;
  }
  .voice-label{opacity:0.8;font-size:13px;width:98px;}

  @media (max-width:980px){
    .app{flex-direction:column;padding:18px;}
    .panel-left{min-width:unset;}
    .panel-right{width:100%;}
    .controller{transform:scale(.95);}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="app" role="application" aria-label="Microbit Controller App">
    <div class="panel-left">
      <div class="controller" id="controller">

        <!-- Up -->
        <div class="arrow-btn up" data-dir="FORWARD" id="btn-up" title="Forward" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M12 4l-6 6h4v8h4v-8h4z"/></svg>
        </div>

        <!-- Left -->
        <div class="arrow-btn left" data-dir="LEFT" id="btn-left" title="Left" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M4 12l6-6v4h10v4H10v4z"/></svg>
        </div>

        <!-- Center voice button (press & hold) -->
        <div class="dot" id="voiceBtn" title="Press and hold to speak" role="button" tabindex="0" aria-pressed="false" aria-label="Voice input">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 19 11h-2z"/></svg>
        </div>

        <!-- Right -->
        <div class="arrow-btn right" data-dir="RIGHT" id="btn-right" title="Right" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M20 12l-6 6v-4H4v-4h10V6z"/></svg>
        </div>

        <!-- Down -->
        <div class="arrow-btn down" data-dir="BACKWARD" id="btn-down" title="Backward" role="button" tabindex="0" aria-pressed="false">
          <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M12 20l6-6h-4V6h-4v8H6z"/></svg>
        </div>

        <div class="ripple" id="ripple"></div>
      </div>
    </div>

    <div class="panel-right">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="min-height:40px"></div>
        <div style="text-align:right">
          <div id="conn-status" class="status">Not connected</div>
        </div>
      </div>

      <!-- ONE SLIDER (renamed Speed) -->
      <div class="sliders" aria-label="controls">
        <div class="slider-row">
          <div class="slider-label">SPEED</div>
          <input id="slider1" type="range" min="0" max="100" value="50" aria-label="Speed control">
          <div id="v1" class="value-badge">50</div>
        </div>

        <!-- voice recognized text -->
        <div class="voice-display" id="voiceDisplay">
          <div class="voice-label">Recognized</div>
          <div id="voiceText" style="flex:1; opacity:.98">â€”</div>
        </div>

        <!-- Connect / Disconnect controls (simple labels) -->
        <div class="device-controls" style="margin-top:6px;">
          <button id="connectBtn" class="btn" title="Connect">Connect</button>
          <button id="disconnectBtn" class="btn ghost" title="Disconnect">Disconnect</button>
          <div style="flex:1"></div>
        </div>
      </div>

      <div class="footer" aria-hidden="true">
        <div></div>
        <div style="display:flex;gap:10px;align-items:center"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* BLE (Nordic UART) - Connect/Disconnect via browser picker */
const nusService = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const nusTxChar  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
const nusRxChar  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

let bleServer = null;
let txCharacteristic = null;
let rxCharacteristic = null;
let pairedDevice = null;

const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const connStatus = document.getElementById('conn-status');

const slider1 = document.getElementById('slider1');
const v1 = document.getElementById('v1');

const voiceTextEl = document.getElementById('voiceText');
const ripple = document.getElementById('ripple');
const voiceBtn = document.getElementById('voiceBtn');

function setStatus(text, color){
  connStatus.textContent = text;
  connStatus.style.color = color || 'white';
}

/* Connect: browser picker -> pair -> connect GATT */
async function connectFlow(){
  try{
    setStatus('Pairing...', 'yellow');
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [nusService]
    });
    pairedDevice = device;
    device.addEventListener('gattserverdisconnected', onDisconnected);
    setStatus('Connecting to ' + (device.name || 'device'), 'yellow');
    const server = await device.gatt.connect();
    bleServer = server;
    const service = await server.getPrimaryService(nusService);
    txCharacteristic = await service.getCharacteristic(nusTxChar);
    try{
      rxCharacteristic = await service.getCharacteristic(nusRxChar);
      await rxCharacteristic.startNotifications();
      rxCharacteristic.addEventListener('characteristicvaluechanged', e=>{
        const txt = new TextDecoder().decode(e.target.value);
        console.log('RX:', txt);
      });
    }catch(_){}
    setStatus('Connected: ' + (device.name || 'unnamed'), '#b5f27d');
  }catch(err){
    console.warn('Connect failed', err);
    setStatus('Not connected', 'salmon');
  }
}
connectBtn.addEventListener('click', connectFlow);

/* Disconnect */
function onDisconnected(){
  setStatus('Disconnected', 'white');
  bleServer = null; txCharacteristic = null; rxCharacteristic = null; pairedDevice = null;
}
disconnectBtn.addEventListener('click', ()=>{
  if(pairedDevice && pairedDevice.gatt && pairedDevice.gatt.connected){
    pairedDevice.gatt.disconnect();
    setStatus('Disconnected', 'white');
  } else {
    setStatus('Not connected', 'white');
  }
});

/* Send command */
async function sendCommand(str){
  doRipple();
  try{
    if(!txCharacteristic){ setStatus('Not connected', 'salmon'); return; }
    const data = new TextEncoder().encode(str + '\n');
    await txCharacteristic.writeValue(data);
  }catch(e){ console.error('Send failed', e); setStatus('Send failed','salmon'); }
}

/* Arrow behaviour: sending commands; STOP not sent if voiceActive true */
let voiceActive = false;
let activeKeys = {};

document.querySelectorAll('.arrow-btn').forEach(btn=>{
  const dirCmd = btn.dataset.dir; // FORWARD, BACKWARD, LEFT, RIGHT
  const press = (ev)=>{ ev.preventDefault(); btn.classList.add('pressed'); btn.setAttribute('aria-pressed','true');
                        // pressing arrow cancels voice mode
                        if(voiceActive){ voiceActive = false; voiceTextEl.textContent = 'â€”'; voiceBtn.classList.remove('listening'); }
                        sendCommand(dirCmd); };
  const release = (ev)=>{ ev.preventDefault(); btn.classList.remove('pressed'); btn.setAttribute('aria-pressed','false');
                          if(!voiceActive) sendCommand('STOP'); };
  btn.addEventListener('mousedown',press);
  btn.addEventListener('touchstart',press,{passive:true});
  btn.addEventListener('mouseup',release);
  btn.addEventListener('mouseleave',release);
  btn.addEventListener('touchend',release);
  btn.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){ if(!activeKeys[dirCmd]){ activeKeys[dirCmd]=true; press(e);} }});
  btn.addEventListener('keyup',e=>{ if(e.key===' '||e.key==='Enter'){ activeKeys[dirCmd]=false; release(e);} });
});

/* Ripple animation */
function doRipple(){
  const size = 120;
  ripple.style.width = ripple.style.height = size+'px';
  ripple.style.left = 'calc(50% - '+(size/2)+'px)';
  ripple.style.top  = 'calc(50% - '+(size/2)+'px)';
  ripple.animate(
    [{transform:'scale(0)',opacity:.28},{transform:'scale(1.08)',opacity:.12},{transform:'scale(1.6)',opacity:0}],
    {duration:520,easing:'cubic-bezier(.2,.9,.3,1)'}
  );
}

/* Slider (Speed) */
let s1Busy=false;
slider1.addEventListener('input', e=>{
  v1.textContent = e.target.value;
  if(s1Busy) return;
  s1Busy=true;
  sendCommand(`SPEED:${e.target.value}`);
  setTimeout(()=>s1Busy=false,120);
});

/* Voice (press & hold) using Web Speech API */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recognizer = null;
let pressListening = false;

function mapVoiceToCommand(text){
  const t = text.trim().toLowerCase();
  if(t.includes('forward') || t.includes('up') || t.includes('ahead') || t.includes('go')) return 'FORWARD';
  if(t.includes('back') || t.includes('backward') || t.includes('down') || t.includes('reverse')) return 'BACKWARD';
  if(t.includes('left')) return 'LEFT';
  if(t.includes('right')) return 'RIGHT';
  if(t.includes('stop') || t.includes('halt')) return 'STOP';
  return null;
}

function startVoiceCapture(){
  if(!SpeechRecognition){ alert('Speech recognition not supported in this browser.'); return; }
  if(pressListening) return;
  // create recognizer lazily
  if(!recognizer){
    recognizer = new SpeechRecognition();
    recognizer.lang = 'en-US';
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;
    recognizer.onresult = (e)=>{
      const transcript = e.results[0][0].transcript.trim();
      voiceTextEl.textContent = transcript || 'â€”';
      // send raw voice text
      sendCommand(`VOICE:${transcript}`);
      // map to movement
      const mapped = mapVoiceToCommand(transcript);
      if(mapped){
        voiceActive = true; // lock stop until user presses arrow
        sendCommand(mapped);
        voiceBtn.classList.add('listening');
      } else {
        voiceActive = true;
        voiceBtn.classList.add('listening');
      }
    };
    recognizer.onerror = (err)=>{
      console.warn('Speech error', err);
    };
    recognizer.onend = ()=>{
      // when user releases, onend will fire. Keep voiceActive true until arrow pressed (per requested behavior).
      pressListening = false;
      voiceBtn.classList.remove('active-press'); // visual release effect
    };
  }
  pressListening = true;
  voiceBtn.classList.add('listening','active-press');
  try { recognizer.start(); } catch(e) { console.warn('recognizer start error', e); }
}

function stopVoiceCapture(){
  if(!recognizer) return;
  try { recognizer.stop(); } catch(e) { console.warn('recognizer stop error', e); }
  // actual handling (voiceActive setting) happens in onresult / onend
}

/* Press & hold handlers for voice button (mouse/touch + keyboard) */
voiceBtn.addEventListener('mousedown', (e)=> { e.preventDefault(); startVoiceCapture(); });
voiceBtn.addEventListener('touchstart', (e)=> { e.preventDefault(); startVoiceCapture(); }, {passive:false});

voiceBtn.addEventListener('mouseup', (e)=> { e.preventDefault(); stopVoiceCapture(); });
voiceBtn.addEventListener('mouseleave', (e)=> { e.preventDefault(); stopVoiceCapture(); });
voiceBtn.addEventListener('touchend', (e)=> { e.preventDefault(); stopVoiceCapture(); }, {passive:false});
voiceBtn.addEventListener('touchcancel', (e)=> { e.preventDefault(); stopVoiceCapture(); }, {passive:false});

/* keyboard: hold Space or Enter to start, release to stop */
let keyVoiceHeld = false;
voiceBtn.addEventListener('keydown', (e)=>{
  if((e.key === ' ' || e.key === 'Enter') && !keyVoiceHeld){ e.preventDefault(); keyVoiceHeld = true; startVoiceCapture(); }
});
voiceBtn.addEventListener('keyup', (e)=>{
  if((e.key === ' ' || e.key === 'Enter')){ e.preventDefault(); keyVoiceHeld = false; stopVoiceCapture(); }
});

/* Keyboard arrow support: pressing arrows same as clicks.
   Pressing an arrow will cancel voiceActive (clear voice text and unlock STOP).
*/
window.addEventListener('keydown', (e)=>{
  const map = {'ArrowUp':'FORWARD','ArrowDown':'BACKWARD','ArrowLeft':'LEFT','ArrowRight':'RIGHT'};
  if(map[e.key]){
    const dir = map[e.key];
    const btn = document.querySelector(`.arrow-btn[data-dir="${dir}"]`);
    if(btn && !btn.classList.contains('pressed')){
      if(voiceActive){ voiceActive=false; voiceTextEl.textContent='â€”'; voiceBtn.classList.remove('listening'); }
      btn.classList.add('pressed');
      sendCommand(dir);
    }
  }
});
window.addEventListener('keyup', (e)=>{
  const map = {'ArrowUp':'FORWARD','ArrowDown':'BACKWARD','ArrowLeft':'LEFT','ArrowRight':'RIGHT'};
  if(map[e.key]){
    const dir = map[e.key];
    const btn = document.querySelector(`.arrow-btn[data-dir="${dir}"]`);
    if(btn && btn.classList.contains('pressed')){
      btn.classList.remove('pressed');
      if(!voiceActive) sendCommand('STOP');
    }
  }
});
</script>
</body>
</html>
